{% extends 'accounts/base_teacher.html' %}
{% load static %}

{% block title_content %}Exam Schedule{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <!-- Header with Add Exam Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Exam Schedule</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExamModal">
            <i class="fas fa-plus"></i> Schedule New Exam
        </button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form class="row g-3">
                <div class="col-md-3">
                    <label for="courseFilter" class="form-label">Course</label>
                    <select class="form-select" id="courseFilter">
                        <option value="">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search exams...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-secondary w-100" id="resetFilters">
                        <i class="fas fa-sync-alt"></i> Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="currentMonth">
                        {{ current_month|date:"F Y" }}
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary active">Month</button>
                    <button type="button" class="btn btn-outline-secondary">Week</button>
                    <button type="button" class="btn btn-outline-secondary">List</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Sunday</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                            <th>Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar_weeks %}
                        <tr>
                            {% for day, exams in week %}
                            <td class="{% if day.month != current_month.month %}text-muted{% endif %} {% if day == today %}bg-light{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">{{ day.day }}</span>
                                    {% if day == today %}
                                    <span class="badge bg-primary">Today</span>
                                    {% endif %}
                                </div>
                                {% for exam in exams %}
                                <div class="exam-item mb-1 p-1 rounded" style="background-color: rgba(52, 152, 219, 0.1);">
                                    <small class="d-block text-truncate">
                                        <i class="fas fa-file-alt text-primary"></i>
                                        {{ exam.course.name }}
                                    </small>
                                    <small class="d-block text-muted">
                                        {{ exam.start_time|time:"g:i A" }}
                                    </small>
                                </div>
                                {% endfor %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upcoming Exams -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Upcoming Exams</h5>
        </div>
        <div class="card-body">
            {% if upcoming_exams %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Exam Title</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exam in upcoming_exams %}
                        <tr>
                            <td>{{ exam.course.name }}</td>
                            <td>{{ exam.title }}</td>
                            <td>{{ exam.date|date:"M d, Y" }}</td>
                            <td>{{ exam.start_time|time:"g:i A" }}</td>
                            <td>{{ exam.duration }} mins</td>
                            <td>{{ exam.room }}</td>
                            <td>
                                <span class="badge bg-{% if exam.date > today %}warning{% elif exam.date == today %}success{% else %}secondary{% endif %}">
                                    {% if exam.date > today %}Upcoming{% elif exam.date == today %}Today{% else %}Completed{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <img src="{% static 'img/no-exams.svg' %}" alt="No Exams" style="width: 200px; margin-bottom: 20px;">
                <h3>No Upcoming Exams</h3>
                <p class="text-muted">Schedule your first exam to get started!</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExamModal">
                    <i class="fas fa-plus"></i> Schedule New Exam
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Exam Modal -->
<div class="modal fade" id="addExamModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule New Exam</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="examForm" method="POST" action="{% url 'teacher_create_exam' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="course" class="form-label">Course</label>
                        <select class="form-select" id="course" name="course" required>
                            <option value="">Select Course</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Exam Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="time" name="time" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="duration" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="duration" name="duration" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="room" class="form-label">Room</label>
                                <input type="text" class="form-control" id="room" name="room" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="examForm" class="btn btn-primary">Schedule Exam</button>
            </div>
        </div>
    </div>
</div>

<style>
    .exam-item {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .exam-item:hover {
        background-color: rgba(52, 152, 219, 0.2) !important;
    }
    
    td {
        height: 120px;
        width: 14.28%;
        vertical-align: top;
        padding: 8px !important;
    }
    
    .table-bordered td {
        border-color: #dee2e6;
    }
    
    .table thead th {
        background-color: #f8f9fa;
        text-align: center;
        padding: 12px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filters
        const courseFilter = document.getElementById('courseFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        const resetButton = document.getElementById('resetFilters');
        
        // Filter functionality
        function filterExams() {
            const course = courseFilter.value;
            const status = statusFilter.value;
            const search = searchInput.value.toLowerCase();
            
            document.querySelectorAll('tbody tr').forEach(row => {
                let show = true;
                
                if (course && row.dataset.course !== course) show = false;
                if (status && row.dataset.status !== status) show = false;
                if (search && !row.textContent.toLowerCase().includes(search)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        // Event listeners
        courseFilter.addEventListener('change', filterExams);
        statusFilter.addEventListener('change', filterExams);
        searchInput.addEventListener('input', filterExams);
        
        // Reset filters
        resetButton.addEventListener('click', function() {
            courseFilter.value = '';
            statusFilter.value = '';
            searchInput.value = '';
            filterExams();
        });
    });
</script>
{% endblock %}